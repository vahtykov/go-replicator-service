# –°—Ç—Ä—É–∫—Ç—É—Ä–∞ SQL —Ñ–∞–π–ª–æ–≤

## –§–∞–π–ª—ã –≤ –ø–æ—Ä—è–¥–∫–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

### üì¶ 00_master_setup.sql
**–ú–∞—Å—Ç–µ—Ä-—Å–∫—Ä–∏–ø—Ç –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —É—Å—Ç–∞–Ω–æ–≤–∫–∏**

–í—ã–ø–æ–ª–Ω—è–µ—Ç –≤—Å–µ —à–∞–≥–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –≤–µ—Ä—Å–∏—é PostgreSQL (—Ç—Ä–µ–±—É–µ—Ç—Å—è 10+)
- –ó–∞–ø—É—Å–∫–∞–µ—Ç –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Å–∫—Ä–∏–ø—Ç—ã –ø–æ –ø–æ—Ä—è–¥–∫—É
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç summary —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```bash
psql -U postgres -d mydb -f 00_master_setup.sql
```

**–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:** –ü–µ—Ä–≤–∏—á–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å –Ω—É–ª—è.

---

### üóÑÔ∏è 01_create_tables.sql
**–°–æ–∑–¥–∞–Ω–∏–µ —Å–ª—É–∂–µ–±–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü**

–°–æ–∑–¥–∞–µ—Ç:
- `replication_queue` - –æ—á–µ—Ä–µ–¥—å —Å–æ–±—ã—Ç–∏–π –¥–ª—è —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏
- `processed_events` - —Ç–∞–±–ª–∏—Ü–∞ –¥–ª—è –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏
- –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –æ—á–∏—Å—Ç–∫–∏: `cleanup_replication_queue()`, `cleanup_processed_events()`

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```bash
psql -U postgres -d mydb -f 01_create_tables.sql
```

**–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:** –ï—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ –ø–æ—à–∞–≥–æ–≤—É—é —É—Å—Ç–∞–Ω–æ–≤–∫—É –≤–º–µ—Å—Ç–æ –º–∞—Å—Ç–µ—Ä-—Å–∫—Ä–∏–ø—Ç–∞.

---

### ‚öôÔ∏è 02_create_replication_trigger.sql
**–°–æ–∑–¥–∞–Ω–∏–µ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤**

–°–æ–∑–¥–∞–µ—Ç:
- `generic_replication_trigger()` - —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏ —Å –∑–∞—â–∏—Ç–æ–π –æ—Ç –ø–µ—Ç–ª–∏
- `increment_version_on_update()` - –∞–≤—Ç–æ–∏–Ω–∫—Ä–µ–º–µ–Ω—Ç –≤–µ—Ä—Å–∏–∏ –ø—Ä–∏ UPDATE
- `setup_replication_for_table()` - —Å–æ–∑–¥–∞–Ω–∏–µ —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤ –Ω–∞ —Ç–∞–±–ª–∏—Ü–µ
- `remove_replication_from_table()` - —É–¥–∞–ª–µ–Ω–∏–µ —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```bash
psql -U postgres -d mydb -f 02_create_replication_trigger.sql
```

**–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:** –ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è —Å–ª—É–∂–µ–±–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü.

---

### üìù 03_setup_example.sql
**–ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è**

–°–æ–¥–µ—Ä–∂–∏—Ç:
- –ü—Ä–∏–º–µ—Ä—ã –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª–µ–π –≤ —Ç–∞–±–ª–∏—Ü—ã
- –ü—Ä–∏–º–µ—Ä—ã —Å–æ–∑–¥–∞–Ω–∏—è —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤
- –¢–µ—Å—Ç—ã —Ä–∞–±–æ—Ç—ã —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏
- –¢–µ—Å—Ç—ã –∑–∞—â–∏—Ç—ã –æ—Ç –ø–µ—Ç–ª–∏
- –ü–æ–ª–µ–∑–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```bash
# –ü—Ä–æ—Å–º–æ—Ç—Ä (–Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –≤—ã–ø–æ–ª–Ω—è—Ç—å)
cat 03_setup_example.sql

# –ò–ª–∏ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –¥–ª—è —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
psql -U postgres -d mydb -f 03_setup_example.sql
```

**–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:** –î–ª—è –æ–±—É—á–µ–Ω–∏—è –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.

---

### üîÑ 04_migrate_existing_tables.sql
**–ú–∏–≥—Ä–∞—Ü–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ç–∞–±–ª–∏—Ü**

–°–æ–∑–¥–∞–µ—Ç:
- `prepare_table_for_replication()` - –¥–æ–±–∞–≤–ª—è–µ—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è (version, updated_at, updated_by)
- `setup_table_for_replication()` - –ø–æ–ª–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ (–ø–æ–ª—è + —Ç—Ä–∏–≥–≥–µ—Ä—ã)
- `generate_migration_script()` - –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä –º–∏–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Å–∫—Ä–∏–ø—Ç–æ–≤
- –ü—Ä–∏–º–µ—Ä—ã –º–∞—Å—Å–æ–≤–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏ —Ç–∞–±–ª–∏—Ü

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```bash
psql -U postgres -d mydb -f 04_migrate_existing_tables.sql
```

–ó–∞—Ç–µ–º:
```sql
SELECT setup_table_for_replication('users');
```

**–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:** –ü–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –±–∞–∑–æ–≤—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π, –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–∞—à–∏—Ö —Ç–∞–±–ª–∏—Ü.

---

## –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã

### üìñ README.md
**–ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è**

–°–æ–¥–µ—Ä–∂–∏—Ç:
- –ü–æ—Ä—è–¥–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Å–∫—Ä–∏–ø—Ç–æ–≤
- –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç
- –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤—Å–µ—Ö —Ñ—É–Ω–∫—Ü–∏–π
- –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
- –û–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ
- Troubleshooting
- Performance tuning

---

### üìã CHEATSHEET.md
**–ë—ã—Å—Ç—Ä–∞—è —Å–ø—Ä–∞–≤–∫–∞**

–°–æ–¥–µ—Ä–∂–∏—Ç –≤—Å–µ —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –∫–æ–º–∞–Ω–¥—ã:
- –£—Å—Ç–∞–Ω–æ–≤–∫–∞
- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç–∞–±–ª–∏—Ü
- –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
- –û—á–∏—Å—Ç–∫–∞
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç—Ä–∏–≥–≥–µ—Ä–∞–º–∏
- Troubleshooting

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:** –î–µ—Ä–∂–∏—Ç–µ –æ—Ç–∫—Ä—ã—Ç—ã–º –≤–æ –≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã!

---

### üìÑ FILES.md
**–≠—Ç–æ—Ç —Ñ–∞–π–ª**

–û–ø–∏—Å–∞–Ω–∏–µ –≤—Å–µ—Ö SQL —Ñ–∞–π–ª–æ–≤ –∏ –∏—Ö –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è.

---

## –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π –ø–æ—Ä—è–¥–æ–∫ –∏–∑—É—á–µ–Ω–∏—è

1. **README.md** - –Ω–∞—á–Ω–∏—Ç–µ –æ—Ç—Å—é–¥–∞ –¥–ª—è –ø–æ–Ω–∏–º–∞–Ω–∏—è –æ–±—â–µ–π –∫–∞—Ä—Ç–∏–Ω—ã
2. **00_master_setup.sql** - –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —É—Å—Ç–∞–Ω–æ–≤–∫–∏
3. **CHEATSHEET.md** - –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–∞–∫ —Å–ø—Ä–∞–≤–∫—É –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ
4. **03_setup_example.sql** - –∏–∑—É—á–∏—Ç–µ –ø—Ä–∏–º–µ—Ä—ã
5. **04_migrate_existing_tables.sql** - –ø—Ä–∏–º–µ–Ω–∏—Ç–µ –∫ —Å–≤–æ–∏–º —Ç–∞–±–ª–∏—Ü–∞–º

## –ë—ã—Å—Ç—Ä–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ (TL;DR)

```bash
# 1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ (–æ–¥–Ω–∞ –∫–æ–º–∞–Ω–¥–∞)
psql -U postgres -d mydb -f 00_master_setup.sql

# 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤–∞—à–∏—Ö —Ç–∞–±–ª–∏—Ü
psql -U postgres -d mydb -c "SELECT setup_table_for_replication('users');"
psql -U postgres -d mydb -c "SELECT setup_table_for_replication('orders');"

# 3. –ì–æ—Ç–æ–≤–æ! ‚úÖ
```

## –°–æ–∑–¥–∞–≤–∞–µ–º—ã–µ –æ–±—ä–µ–∫—Ç—ã

### –¢–∞–±–ª–∏—Ü—ã (2)
- `replication_queue`
- `processed_events`

### –§—É–Ω–∫—Ü–∏–∏ (9)
- `generic_replication_trigger()`
- `increment_version_on_update()`
- `setup_replication_for_table(table_name, schema_name)`
- `remove_replication_from_table(table_name, schema_name)`
- `cleanup_replication_queue(retention_days)`
- `cleanup_processed_events(retention_days)`
- `prepare_table_for_replication(table_name, schema_name)`
- `setup_table_for_replication(table_name, schema_name)`
- `generate_migration_script(tables[], schema_name)`

### –¢—Ä–∏–≥–≥–µ—Ä—ã (–Ω–∞ –∫–∞–∂–¥–æ–π –Ω–∞—Å—Ç—Ä–æ–µ–Ω–Ω–æ–π —Ç–∞–±–ª–∏—Ü–µ)
- `{table}_version_trigger` (BEFORE INSERT OR UPDATE)
- `{table}_replication_trigger` (AFTER INSERT OR UPDATE OR DELETE)

### –ò–Ω–¥–µ–∫—Å—ã
- `idx_repl_queue_unpublished` –Ω–∞ `replication_queue`
- `idx_repl_queue_table` –Ω–∞ `replication_queue`
- `idx_processed_events_timestamp` –Ω–∞ `processed_events`

## –†–∞–∑–º–µ—Ä –∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

**Overhead:**
- –¢—Ä–∏–≥–≥–µ—Ä—ã: ~10-15% –Ω–∞ –∫–∞–∂–¥—É—é DML –æ–ø–µ—Ä–∞—Ü–∏—é
- –ú–µ—Å—Ç–æ –Ω–∞ –¥–∏—Å–∫–µ: ~1KB –Ω–∞ —Å–æ–±—ã—Ç–∏–µ –≤ `replication_queue`

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:**
- –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞—Ç—å `cleanup_replication_queue(7)` - —Ä–∞–∑ –≤ –¥–µ–Ω—å
- –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞—Ç—å `cleanup_processed_events(30)` - —Ä–∞–∑ –≤ –Ω–µ–¥–µ–ª—é
- –ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å —Ä–∞–∑–º–µ—Ä –æ—á–µ—Ä–µ–¥–∏ –Ω–µ–æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π
- –ù–∞—Å—Ç—Ä–æ–∏—Ç—å autovacuum –¥–ª—è –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

**–ó–∞—â–∏—Ç–∞ –æ—Ç –ø–µ—Ç–ª–∏ —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏:**
- ‚úÖ –í—Å—Ç—Ä–æ–µ–Ω–∞ –≤ `generic_replication_trigger()`
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ `application_name = 'replicator_consumer'`
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ ReplicatorConsumer
- ‚úÖ –ù–µ —Ç—Ä–µ–±—É–µ—Ç —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö –ø—Ä–∞–≤ (—Ä–∞–±–æ—Ç–∞–µ—Ç —Å –æ–±—ã—á–Ω–æ–π —É—á–µ—Ç–Ω–æ–π –∑–∞–ø–∏—Å—å—é)

**–ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞:**
- –¢—Ä–∏–≥–≥–µ—Ä—ã: —Ç—Ä–µ–±—É—é—Ç –ø—Ä–∞–≤ –Ω–∞ INSERT –≤ `replication_queue`
- –§—É–Ω–∫—Ü–∏–∏: PUBLIC EXECUTE (–º–æ–∂–Ω–æ –æ–≥—Ä–∞–Ω–∏—á–∏—Ç—å)
- –¢–∞–±–ª–∏—Ü—ã: SELECT –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞, INSERT/UPDATE/DELETE –¥–ª—è —Å–µ—Ä–≤–∏—Å–æ–≤

## –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å

**PostgreSQL –≤–µ—Ä—Å–∏–∏:**
- –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è: 10
- –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ: 10, 11, 12, 13, 14, 15, 16
- –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–∞—è: 13+

**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:**
- –†–∞—Å—à–∏—Ä–µ–Ω–∏—è: –Ω–µ—Ç (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π SQL –∏ PL/pgSQL)
- –í–Ω–µ—à–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏: –Ω–µ—Ç

## –ü–æ–¥–¥–µ—Ä–∂–∫–∞

**–í–æ–ø—Ä–æ—Å—ã –∏ –ø—Ä–æ–±–ª–µ–º—ã:**
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ [CHEATSHEET.md](CHEATSHEET.md) - Troubleshooting —Å–µ–∫—Ü–∏—è
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ [README.md](README.md) - —Å–µ–∫—Ü–∏—è Troubleshooting
3. –ò–∑—É—á–∏—Ç–µ –ª–æ–≥–∏ PostgreSQL
4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –º–µ—Ç—Ä–∏–∫–∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

**–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:**
```sql
-- –í–∫–ª—é—á–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤ (–¥–ª—è debug)
SET client_min_messages = DEBUG;

-- –í—ã–ø–æ–ª–Ω–∏—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é
INSERT INTO users (name) VALUES ('test');

-- –í–µ—Ä–Ω—É—Ç—å –æ–±—Ä–∞—Ç–Ω–æ
SET client_min_messages = NOTICE;
```

