# ReplicatorPublisher - –ß–µ–∫–ª–∏—Å—Ç –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏

## ‚úÖ –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

- [x] **Config** - –∑–∞–≥—Ä—É–∑–∫–∞ –∏–∑ YAML + –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
- [x] **Logger** - Zerolog —Å —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º
- [x] **Database** - GORM –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Å SSL –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π
- [x] **Kafka Producer** - confluent-kafka-go —Å SSL –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π
- [x] **Publisher Logic** - –±–∞—Ç—á–µ–≤–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å `SELECT FOR UPDATE SKIP LOCKED`
- [x] **Main** - graceful shutdown, –º–µ—Ç—Ä–∏–∫–∏

### –ö–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

- [x] **SELECT FOR UPDATE SKIP LOCKED** - –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ deadlocks
- [x] **At-least-once delivery** - —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–∞—è –≥–∞—Ä–∞–Ω—Ç–∏—è
- [x] **–ë–∞—Ç—á–µ–≤–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞** - —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–∞—è –ø—É–±–ª–∏–∫–∞—Ü–∏—è
- [x] **SSL –ø–æ–¥–¥–µ—Ä–∂–∫–∞** - PostgreSQL –∏ Kafka
- [x] **Graceful shutdown** - –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ
- [x] **Horizontal scaling** - –Ω–µ—Å–∫–æ–ª—å–∫–æ —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤ –±–µ–∑ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤
- [x] **–ú–µ—Ç—Ä–∏–∫–∏** - processed/failed count

### –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- [x] **PUBLISHER_README.md** - –ø–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- [x] **TEST_PUBLISHER.md** - –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é
- [x] **Makefile** - —É–¥–æ–±–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã
- [x] **config.publisher.yaml** - –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º–∏
- [x] **.gitignore** - –∏—Å–∫–ª—é—á–µ–Ω–∏—è –¥–ª—è git

### –§–∞–π–ª—ã

```
‚úÖ cmd/publisher/main.go
‚úÖ internal/config/config.go
‚úÖ internal/logger/logger.go
‚úÖ internal/database/connection.go
‚úÖ internal/database/models.go
‚úÖ internal/kafka/producer.go
‚úÖ internal/publisher/publisher.go
‚úÖ internal/publisher/event.go
‚úÖ internal/publisher/clause.go
‚úÖ config.publisher.yaml
‚úÖ go.mod
‚úÖ go.sum
‚úÖ Makefile
‚úÖ .gitignore
‚úÖ PUBLISHER_README.md
‚úÖ TEST_PUBLISHER.md
```

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ü–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º

1. [ ] PostgreSQL –Ω–∞—Å—Ç—Ä–æ–µ–Ω (`sql/00_master_setup.sql`)
2. [ ] Kafka –¥–æ—Å—Ç—É–ø–Ω–∞
3. [ ] –¢–∞–±–ª–∏—Ü—ã –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –¥–ª—è —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏ (`setup_table_for_replication`)
4. [ ] `config.publisher.yaml` –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω

### –ë–∞–∑–æ–≤—ã–µ —Ç–µ—Å—Ç—ã

1. [ ] –ö–æ–º–ø–∏–ª—è—Ü–∏—è: `make build-publisher`
2. [ ] –ó–∞–ø—É—Å–∫: `./bin/publisher -config config.publisher.yaml`
3. [ ] INSERT –≤ —Ç–∞–±–ª–∏—Ü—É ‚Üí —Å–æ–±—ã—Ç–∏–µ –≤ Kafka
4. [ ] UPDATE –≤ —Ç–∞–±–ª–∏—Ü—É ‚Üí —Å–æ–±—ã—Ç–∏–µ –≤ Kafka
5. [ ] DELETE –∏–∑ —Ç–∞–±–ª–∏—Ü—ã ‚Üí —Å–æ–±—ã—Ç–∏–µ –≤ Kafka
6. [ ] Graceful shutdown (Ctrl+C) ‚Üí –º–µ—Ç—Ä–∏–∫–∏ –≤ –ª–æ–≥–∞—Ö

### –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ —Ç–µ—Å—Ç—ã

7. [ ] –ú–∞—Å—Å–æ–≤—ã–µ INSERT (1000 –∑–∞–ø–∏—Å–µ–π) ‚Üí –≤—Å–µ –≤ Kafka
8. [ ] –î–≤–∞ —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ Publisher ‚Üí –Ω–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤
9. [ ] Kafka –æ—Ç–∫–ª—é—á–µ–Ω–∞ ‚Üí –∑–∞–ø–∏—Å–∏ –≤ `published=false`
10. [ ] Kafka –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ ‚Üí –≤—Å–µ –ø—É–±–ª–∏–∫—É–µ—Ç—Å—è
11. [ ] SSL PostgreSQL ‚Üí —É—Å–ø–µ—à–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
12. [ ] SSL Kafka ‚Üí —É—Å–ø–µ—à–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ

---

## üìä –ú–µ—Ç—Ä–∏–∫–∏ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –ó–∞–ø—Ä–æ—Å—ã –∫ –ë–î

```sql
-- –ù–µ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏ (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å ~0)
SELECT COUNT(*) FROM replication_queue WHERE published = FALSE;

-- –ó–∞–¥–µ—Ä–∂–∫–∞ —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏
SELECT NOW() - MAX(created_at) as lag
FROM replication_queue WHERE published = FALSE;
```

### Kafka

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–ø–∏–∫–æ–≤
kafka-topics --list --bootstrap-server localhost:9092

# –ß—Ç–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π
kafka-console-consumer --topic users_changes --from-beginning --bootstrap-server localhost:9092
```

### –õ–æ–≥–∏ Publisher

```json
{"level":"info","component":"publisher","count":100,"duration_ms":234,"total_processed":1523}
```

---

## üöÄ Production Ready

### –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

- [x] –ö–æ–¥ —Å–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω –±–µ–∑ –æ—à–∏–±–æ–∫
- [x] –ë–∞–∑–æ–≤—ã–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã
- [ ] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã (—Ç—Ä–µ–±—É—é—Ç –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã)
- [ ] –ù–∞–≥—Ä—É–∑–æ—á–Ω—ã–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã
- [ ] –ù–∞—Å—Ç—Ä–æ–µ–Ω –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ (Prometheus/Grafana)
- [ ] –ù–∞—Å—Ç—Ä–æ–µ–Ω—ã –∞–ª–µ—Ä—Ç—ã (replication lag)
- [ ] –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∞ —Å –∫–æ–º–∞–Ω–¥–æ–π

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞

1. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:**
   - Replication lag < 5 —Å–µ–∫—É–Ω–¥
   - Unpublished events < 1000
   - Error rate < 1%

2. **–ê–ª–µ—Ä—Ç—ã:**
   - Replication lag > 10 —Å–µ–∫—É–Ω–¥ ‚Üí WARNING
   - Replication lag > 30 —Å–µ–∫—É–Ω–¥ ‚Üí CRITICAL
   - Publisher down ‚Üí CRITICAL

3. **–ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ:**
   - 1 —ç–∫–∑–µ–º–ø–ª—è—Ä –Ω–∞ –º–∞–ª—É—é –Ω–∞–≥—Ä—É–∑–∫—É (< 100 —Å–æ–±—ã—Ç–∏–π/—Å–µ–∫)
   - 2-3 —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ –Ω–∞ —Å—Ä–µ–¥–Ω—é—é –Ω–∞–≥—Ä—É–∑–∫—É (100-500 —Å–æ–±—ã—Ç–∏–π/—Å–µ–∫)
   - 5+ —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤ –Ω–∞ –≤—ã—Å–æ–∫—É—é –Ω–∞–≥—Ä—É–∑–∫—É (> 500 —Å–æ–±—ã—Ç–∏–π/—Å–µ–∫)

4. **–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –±–∞—Ç—á–µ–π:**
   - `batch_size: 100-500` (–≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –Ω–∞–≥—Ä—É–∑–∫–∏)
   - `poll_interval: 500ms-2s` (–≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π –∫ latency)

5. **–û—á–∏—Å—Ç–∫–∞ –ë–î:**
   - –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –æ—á–∏—â–∞–π—Ç–µ —Å—Ç–∞—Ä—ã–µ –∑–∞–ø–∏—Å–∏:
   ```sql
   DELETE FROM replication_queue 
   WHERE published = TRUE 
   AND published_at < NOW() - INTERVAL '7 days';
   ```

---

## üéØ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. ‚úÖ **ReplicatorPublisher** - –ó–ê–í–ï–†–®–ï–ù–û
2. ‚è≥ **ReplicatorConsumer** - –°–õ–ï–î–£–Æ–©–ò–ô
3. ‚è≥ **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã**
4. ‚è≥ **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –∞–ª–µ—Ä—Ç—ã**
5. ‚è≥ **Production deployment**

---

## üìû –í–æ–ø—Ä–æ—Å—ã –¥–ª—è —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è

–ü–µ—Ä–µ–¥ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–µ–π **ReplicatorConsumer** —Å–æ–≥–ª–∞—Å—É–π—Ç–µ:

1. **–ó–∞—â–∏—Ç–∞ –æ—Ç –ø–µ—Ç–ª–∏ —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏:**
   - ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º `application_name=replicator_consumer`
   - ‚úÖ –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ `source.contour`

2. **–ö–æ–Ω—Ñ–ª–∏–∫—Ç—ã –¥–∞–Ω–Ω—ã—Ö:**
   - –°—Ç—Ä–∞—Ç–µ–≥–∏—è: Last-Write-Wins –ø–æ `version`
   - –ü—Ä–∏ `version_incoming <= version_current` ‚Üí SKIP

3. **–ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å:**
   - –¢–∞–±–ª–∏—Ü–∞ `processed_events` —Å `event_id`
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–¥ –∫–∞–∂–¥—ã–º –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ–º

4. **Referential Integrity:**
   - `SET CONSTRAINTS ALL DEFERRED` –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏

5. **Consumer Group:**
   - –û—Ç–¥–µ–ª—å–Ω–∞—è group –Ω–∞ –∫–∞–∂–¥–æ–º –∫–æ–Ω—Ç—É—Ä–µ
   - –ò–º—è: `replicator-consumer-{contour}`

---

–ì–æ—Ç–æ–≤–æ! üéâ ReplicatorPublisher –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –∏ –≥–æ—Ç–æ–≤ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é.

