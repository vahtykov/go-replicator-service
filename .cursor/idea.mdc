---
alwaysApply: true
---
## Прикладная репликация на Golang + Postgres Triggers.

# Компоненты прикладной репликации:
1) Триггер на БД - На каждой таблице, требующей репликации данных между контурами, добавляется триггер, который автоматически записывает каждую DML операцию на таблице в replication_queue.
2) ReplicatorPublisher - Прикладной сервис для чтения реплицируемых данных из БД (таблица replication_queue) и записи в Kafka.
3) ReplicatorConsumer - Прикладной сервис чтения данных из Kafka для каждой таблицы бд (топик = таблица бд), применение на БД DML с противоположного контура.
4) Kafka - Георезервированный буфер между контурами. Для каждой реплицированной таблицы свой топик.

ReplicatorPublisher, ReplicatorConsumer разворачиваются в виде подов в OpenShift на каждом контуре АС.

Порядок запуска сервисов не имеет значения.

# Триггер на БД:
- Устанавливается на все реплицируемые таблицы
- Автоматический захват всех DML операции
- Запись всех DML операций по таблице БД в replicaton_queue
- Тип триггера - "AFTER INSERT OR UPDATE OR DELETE"
- Не требует изменений в прикладных сервисах АС
- Избежание петли репликации путем задания application_name = 'replicator_consumer' и пропуск операций от данного сервиса на уровне триггера репликации

# Таблицы бд:
replication_queue - хранение DML операций подлежащих к репликации.
replication_processed_events - история реплицированных записей (хранит ID записей, позволяет избежать двойного применения одной и той же операции).

# Kafka (кафку поднимать не нужно, привожу чисто для информации):
- Георезервированная (к ней имеют доступ оба контура АС)
- Отдельный топик для каждой таблицы
- Своя consumer group на каждом контуре
- Partition key = Primary key (для сохранения порядка изменения одной записи)


## Поток данных

```
Приложение
    ↓
PostgreSQL → [Триггер AFTER] → replication_queue
                                      ↓
                              ReplicatorPublisher (каждые 1 сек)
                                      ↓
                                   Kafka
                                      ↓
                              ReplicatorConsumer
                                      ↓
                              [Отключает триггеры]
                                      ↓
                          PostgreSQL (другой контур)

Задержка репликации: 1-3 секунды
```

---